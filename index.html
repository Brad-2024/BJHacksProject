<!DOCTYPE html>
<html lang="en">
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const loginSection = document.getElementById('loginSection');
        const logoutButton = document.getElementById('logout');
        const userIcon = document.querySelector('.accountIcon');
        const container = document.querySelector('.container');

        if (isLoggedIn) {
            loginSection.style.display = 'none';
            container.style.display = 'flex';
            logoutButton.style.display = 'flex';
            userIcon.style.display = 'block';
        } else {
            loginSection.style.display = 'flex';
            container.style.display = 'none';
            logoutButton.style.display = 'none';
            userIcon.style.display = 'none';
        }
    });
</script>
<head>
    <meta charset="UTF-8">
    <title>Flight Footprint</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="accountIcon" onclick="window.location.href='account.html'">
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z"/></svg>
</div>
<div class="loginSection" id="loginSection">
    <h1>Login</h1>
    <form id="loginForm">
        <div>
            <label for="username">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z"/></svg>
            </label>
            <input type="text" id="username" name="username" placeholder="Username" required>
        </div>
        <div>
            <button type="submit">Login</button>
        </div>
    </form>
    <div id="message"></div>
</div>

<script>
    const form = document.getElementById('loginForm');
    const message = document.getElementById('message');

    form.addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent default form submission
        const username = document.getElementById('username').value;
        // Send the POST request to the backend
        fetch('http://127.0.0.1:5000/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username })
        })

            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Handle successful login
                    message.innerText = `Welcome, ${data.username}!`;                    localStorage.setItem('isLoggedIn', true);
                    localStorage.setItem('username', data.username);
                    window.location.reload();
                } else {
                    // Handle login failure
                    message.style.display = 'block';
                    message.innerText = data.message || 'Login failed. Please try again.';
                    setTimeout(() => {
                        message.innerText = '';
                        message.style.display = 'none';
                    }, 2000);
                }
            })
    });
</script>
<div class="container">
    <div class="header">
        <h1>Flight Footprint</h1>
    </div>
    <div class="content">
        <form id="flight-form" method="post">
            <div class="form-group">
                <label for="from">From</label>
                <select name="from" id="from">
                    <option value="" disabled selected>Select your location</option>
                    <option value="Atlanta">Atlanta</option>
                    <option value="Chicago">Chicago</option>
                    <option value="Seattle">Seattle</option>
                    <option value="Miami">Miami</option>
                </select>
            </div>
            <div class="form-group">
                <label for="to">To</label>
                <select name="to" id="to">
                    <option id="default" value="" disabled selected>Select your destination</option>
                    <option value="Atlanta">Atlanta</option>
                    <option value="Chicago">Chicago</option>
                    <option value="Seattle">Seattle</option>
                    <option value="Miami">Miami</option>
                </select>
            </div>
            <div class="form-button">
                <button type="submit">Calculate</button>
            </div>
        </form>
        <script>
            function showMessage(elementId, text, duration = 2000) {
                const element = document.getElementById(elementId);
                element.textContent = text;
                element.style.display = 'flex'; // Show the message
                setTimeout(() => {
                    element.style.display = 'none'; // Hide the message after the duration
                }, duration);
            }

            document.getElementById('flight-form').addEventListener('submit', function (event) {
                event.preventDefault();
                const username = localStorage.getItem('username');

                const formData = new FormData(this); // Collect form data
                formData.append('username', username);

                fetch('http://127.0.0.1:5000/', {
                    method: 'POST',
                    body: formData,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.error) {
                            if (data.error === 'empty') {
                                showMessage('not-both-selected', 'Error: Please select both departure and arrival airports.');
                            } else if (data.error === 'same') {
                                showMessage('both-same', 'Error: Departure and arrival airports cannot be the same.');
                            }
                        } else {
                            document.querySelector('.result').style.display = 'flex';
                            document.querySelector('.clear').style.display = 'flex';
                            document.getElementById('flight-footprint').textContent = data.footprint;
                            document.getElementById('current-to').textContent = data.to;
                            document.getElementById('current-from').textContent = data.from;
                        }
                    })
                    .catch((error) => console.error('Error:', error));
            });
        </script>
        <div class="result">
            <h1>Result</h1>
            <p>Flight Footprint: <span id="flight-footprint">0</span> kg CO2</p>
            <div class="add_to_profile">
                <button id="addToProfile">Add To Profile</button>
            </div>
            <script>
                document.getElementById('addToProfile').addEventListener('click', function () {
                    const username = localStorage.getItem('username'); // Retrieve username from localStorage
                    const flightFootprint = parseFloat(document.getElementById('flight-footprint').textContent); // Get flight footprint value

                    if (!username || isNaN(flightFootprint)) {
                        console.error('Invalid data. Username or flight footprint is missing.');
                        return;
                    }

                    // Send the username and flight footprint to the backend
                    fetch('http://127.0.0.1:5000/add_to_profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, flightFootprint }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('Profile updated successfully:', data.message);
                            } else {
                                console.error('Failed to update profile:', data.message);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });
            </script>
            <div class="clear">
                <button type="submit">Clear</button>
            </div>
            <script>
                document.querySelector('.clear').addEventListener('click', function() {
                    document.getElementById('flight-form').reset();
                    document.querySelector('.result').style.display = 'none';
                    document.querySelector('.clear').style.display = 'none';
                });
            </script>
        </div>
        <div class="error">
            <p id="not-both-selected" class="floating-message">Error: Please select both departure and arrival airports.</p>
            <p id="both-same" class="floating-message">Error: Departure and arrival airports cannot be the same.</p>
        </div>
    </div>
    <div class="logout" id="logout">
        <button type ="submit">Logout</button>
    </div>
    <script>
        document.getElementById('logout').addEventListener('click', function() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            window.location.reload();
        });
    </script>
</div>

</body>
</html>